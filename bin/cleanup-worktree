#!/usr/bin/env bash
set -euo pipefail

BASE_BRANCH="main"
PROTECTED_BRANCHES="^(main|release)$"
DRY_RUN=false

usage() {
  echo "Usage: $0 [-n|--dry-run]"
  exit 1
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -n|--dry-run)
      DRY_RUN=true
      shift
      ;;
    *)
      usage
      ;;
  esac
done

echo "Base branch : $BASE_BRANCH"
echo "Dry run     : $DRY_RUN"
echo

git worktree list --porcelain |
awk '
  /^worktree / { path=$2 }
  /^branch refs\/heads\// {
    branch=$2
    sub("refs/heads/", "", branch)
    print path, branch
  }
' |
while read -r path branch; do
  if [[ "$branch" =~ $PROTECTED_BRANCHES ]]; then
    echo "SKIP (protected): $branch"
    continue
  fi

  if git merge-base --is-ancestor "$branch" "$BASE_BRANCH"; then
    echo "MERGED: $branch"
    echo "  worktree: $path"

    if [ "$DRY_RUN" = false ]; then
      git worktree remove "$path"
      git branch -d "$branch"
    fi
  else
    echo "KEEP (not merged): $branch"
  fi
done

# vi:ft=sh:
