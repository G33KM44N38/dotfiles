---
- name: Install ghostty on Linux
  block:
    - name: Download ghostty releases
      ansible.builtin.uri:
        url: https://api.github.com/repos/ghostty-org/ghostty/releases
        return_content: true
      register: ghostty_releases

    - name: Check for Linux binary in release
      ansible.builtin.set_fact:
        ghostty_download_url: "{{ ghostty_releases.json[0].assets | selectattr('name', 'match', '.*linux.*x86_64.*tar.gz$') | first | default({}) }}"

    - name: Download and extract ghostty (if Linux binary available)
      ansible.builtin.unarchive:
        src: "{{ ghostty_download_url.browser_download_url }}"
        dest: "{{ ansible_env.HOME }}/.local"
        remote_src: true
        creates: "{{ ansible_env.HOME }}/.local/ghostty"
      when: ghostty_download_url.browser_download_url is defined

    - name: Add ghostty to PATH (if installed)
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        line: 'export PATH="$HOME/.local/ghostty:$PATH"'
        state: present
        create: true
      when: ghostty_download_url.browser_download_url is defined

    - name: Notify about missing Linux binary
      ansible.builtin.debug:
        msg: "Ghostty Linux binary not available in releases. Consider building from source or waiting for official Linux support."
      when: ghostty_download_url.browser_download_url is not defined